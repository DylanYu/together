package com.example.together;import java.io.IOException;import java.util.ArrayList;import java.util.HashMap;import java.util.List;import org.json.JSONException; import info.nemoworks.inmusic.connectivity.JsonHandler;import info.nemoworks.inmusic.connectivity.MyHttpResponse;import info.nemoworks.inmusic.connectivity.MySimpleAdapter;import info.nemoworks.inmusic.models.MessagePost;import info.nemoworks.inmusic.utils.AssetsUtil;import info.nemoworks.inmusic.utils.MyConstants;import info.nemoworks.inmusic.utils.MyUtils;import info.nemoworks.inmusic.widgets.PullToRefreshList;import android.annotation.SuppressLint;import android.app.Activity;import android.app.ListActivity;import android.app.ProgressDialog;import android.content.Context;import android.content.Intent;import android.content.pm.ActivityInfo;import android.os.AsyncTask;import android.os.Bundle;import android.os.Handler;import android.os.Message;import android.util.Log;import android.view.View;import android.view.View.OnClickListener;import android.widget.AdapterView;import android.widget.TextView;import android.widget.AdapterView.OnItemClickListener;@SuppressLint("ParserError")public class HomeActivity extends ListActivity {	private MySimpleAdapter listAdapter;	private ProgressDialog progressDialog;	private ProgressDialog progressDialogFirstTime;	private Context context;	private View loadMoreView;	private TextView loadMoreButton;	private PullToRefreshList listView;	private ArrayList<HashMap<String, Object>> listArray = new ArrayList<HashMap<String, Object>>();	private HashMap<String, Object> map_use;	public void onDestroy() {		if (progressDialog != null)			progressDialog.dismiss();		if (progressDialogFirstTime != null)			progressDialogFirstTime.dismiss();		super.onDestroy();	}	@Override	public void onCreate(Bundle savedInstanceState) {		super.onCreate(savedInstanceState);		setContentView(R.layout.home);		setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_PORTRAIT);		context = this;		listView = ((PullToRefreshList) getListView());		listView.setCacheColorHint(0);		progressDialog = new ProgressDialog(context);		progressDialog.setProgressStyle(ProgressDialog.STYLE_SPINNER);		progressDialog.setIcon(R.drawable.loading);		progressDialog.setMessage(getString(R.string._loading));		progressDialogFirstTime = new ProgressDialog(context);		progressDialogFirstTime.setProgressStyle(ProgressDialog.STYLE_SPINNER);		progressDialogFirstTime.setIcon(R.drawable.loading);		progressDialogFirstTime.setMessage(getString(R.string._loading));		loadMoreView = getLayoutInflater().inflate(R.layout.loadmore, null);		loadMoreButton = (TextView) loadMoreView				.findViewById(R.id.loadMoreButton);		loadMoreButton.setText(R.string._more);		loadMoreButton.setOnClickListener(new View.OnClickListener() {			@Override			public void onClick(View v) {				loadMoreButton.setText(R.string._loading);				progressDialog.show();				new ClickGetDataTask().execute();			}		});		listView.addFooterView(loadMoreView);		listView.setOnRefreshListener(new info.nemoworks.inmusic.widgets.PullToRefreshList.OnRefreshListener() {			@Override			public void onRefresh() {				new PullGetDataTask().execute();			}		});				try {			progressDialogFirstTime.show();			buildlist();		} catch (Exception e) {			e.printStackTrace();		}	}	private boolean bottomFlag = false;	private class PullGetDataTask extends AsyncTask<Void, Void, String[]> {		@Override		protected String[] doInBackground(Void... params) {			// Simulates a background job. 				try {					bottomFlag = false;					buildlist();				} catch (JSONException e) {					e.printStackTrace();				} catch (IOException e) {					e.printStackTrace();				}			 			return null;		}		@Override		protected void onPostExecute(String[] result) {			// Call onRefreshComplete when the list has been refreshed.			((PullToRefreshList) getListView()).onRefreshComplete();			super.onPostExecute(result);		}	}	/**	 * asyntask , used when click loadmore button of listview to refresh data	 * */	private class ClickGetDataTask extends AsyncTask<Void, Void, String[]> {		@Override		protected String[] doInBackground(Void... params) {			// Simulates a background job.			bottomFlag = true;			loadMoreData(true);// add to bottom			return null;		}		@Override		protected void onPostExecute(String[] result) {			// Call onRefreshComplete when the list has been refreshed.			progressDialog.cancel();			super.onPostExecute(result);		}	}	private String msgGet="";	private Handler listHandler = new Handler() {// this is used to generate the													// groups listview		public void handleMessage(Message msg) {			switch (msg.what) {			case MyConstants.MSG_SUCCESS1:				@SuppressWarnings("unchecked")				final ArrayList<HashMap<String, Object>> array = (ArrayList<HashMap<String, Object>>) msg.obj;				loadMoreButton.setText(R.string._more);				listAdapter = new MySimpleAdapter(context, array,						R.layout.list_item, new String[] { "title",								"imgsrc", "desc" }, new int[] {								R.id.sItemTitle, R.id.image, R.id.sItemInfo },						120);				listView.setAdapter(listAdapter);				listArray = array;				listView.setVisibility(View.GONE);				listAdapter.notifyDataSetChanged();				listView.setVisibility(View.VISIBLE);				if (bottomFlag)					listView.setSelectionFromTop(							listAdapter.GetmData().size() - 1, 150);				progressDialogFirstTime.cancel();				listView.setOnItemClickListener(new OnItemClickListener() {					@Override					public void onItemClick(AdapterView<?> arg0, View arg1,							int arg2, long arg3) {						if (arg2 > listArray.size()) {							return;						}						Intent intent = new Intent();						if (arg2 > 0)							arg2--;						intent.putExtra("id",								(String) listArray.get(arg2).get("id"));						intent.putExtra("title", (String) listArray.get(arg2)								.get("title"));						intent.putExtra("description",								(String) listArray.get(arg2).get("description"));						intent.putExtra("url", (String) listArray.get(arg2)								.get("url"));						intent.putExtra("weibo_url",								(String) listArray.get(arg2).get("weibo_url"));//						if (indicateStarFlag == false)//							intent.setClass(StarActivity.this,//									StarDetailsActivity.class);//						else//							intent.setClass(StarActivity.this,//									DjDetailsActivity.class);//						startActivity(intent);					}				});				break;			case MyConstants.MSG_FAILURE:				progressDialog.cancel();				progressDialogFirstTime.cancel();				if (msgGet == null || msgGet.equals("[]")) {					loadMoreButton.setText(R.string.no_more);					if (bottomFlag)						listView.setSelectionFromTop(listAdapter.GetmData()								.size() - 1, 150);				} else					loadMoreButton.setText(R.string._more);				break;			}		}	};	private String msgGetString="";	private void loadMoreData(boolean bottom) {		try { 				add_list(bottom);			 		} catch (JSONException e) {			e.printStackTrace();		} catch (IOException e) {			e.printStackTrace();		}	}		int last_star_id = 0;	private void buildlist() throws JSONException, IOException {		final ArrayList<HashMap<String, Object>> Array = new ArrayList<HashMap<String, Object>>();		new Thread() {			public void run() {				String s = AssetsUtil.getFromAssets(context, "star.json");//				String http_url = "/stars.json?start=0&count="//						+ MyConstants.STAR;				try {//					s = MyHttpResponse.getResponse(http_url);					if (s == null) {						msgGet = s;						Log.d("StarActivity", "null response");						listHandler.obtainMessage(MyConstants.MSG_FAILURE)								.sendToTarget();						return;					}					if (s.equals("[]")) {						// 说明没有更多新闻了，此时msgGet="[]"						msgGet = s;						listHandler.obtainMessage(MyConstants.MSG_FAILURE)								.sendToTarget();						return;					}					JsonHandler jsonHandler = new JsonHandler();					List<MessagePost> stars = jsonHandler.getMessages(s);					HashMap<String, Object> map;					// String url, large_url, id, description, desc, name;					for (MessagePost p : stars) {						map = getMap(p);						Array.add(map);					}					last_star_id = stars.size();				} catch (JSONException e) {					listHandler.obtainMessage(MyConstants.MSG_FAILURE)							.sendToTarget();					e.printStackTrace();					return;				}				if (Array.size() == 0) {					listHandler.obtainMessage(MyConstants.MSG_FAILURE)							.sendToTarget();				} else {					listHandler.obtainMessage(MyConstants.MSG_SUCCESS1, Array)							.sendToTarget();				}			}		}.start();	}	private HashMap<String, Object> getMap(MessagePost p) {		HashMap<String, Object> map;		map = new HashMap<String, Object>();//		String url = p.getUrl();//		String large_url = p.getLargeUrl();		String id = p.getId();		String name = p.getName();		String description = p.getEvent();		String desc = description;		if (description.length() > 30) {			desc = description.substring(0, 29);			desc += "...";		}//		map.put("url", large_url);		map.put("id", id);		map.put("imgsrc", p.getTime());		map.put("desc", desc);		map.put("title", name);		map.put("description", description);		return map;	}	private void add_list(final boolean bottom) throws JSONException,			IOException {		String s = AssetsUtil.getFromAssets(context, "star.json");//		String http_url = "/stars.json?start=" + last_star_id + "&count="//				+ MyConstants.STAR;//		s = MyHttpResponse.getResponse(http_url);		if (s == null) {			Log.d("StarActivity", "null response");			msgGet = s;			listHandler.obtainMessage(MyConstants.MSG_FAILURE).sendToTarget();			return;		}		if (s.equals("[]")) {			// 说明没有更多新闻了，此时msgGet="[]"			msgGet = s;			listHandler.obtainMessage(MyConstants.MSG_FAILURE).sendToTarget();			return;		}		JsonHandler jsonHandler = new JsonHandler();		List<MessagePost> stars = jsonHandler.getMessages(s);		String url, title, large_url, id, description, desc;		ArrayList<HashMap<String, Object>> array = new ArrayList<HashMap<String, Object>>();		for (int i = 0; i < listAdapter.GetmData().size(); i++)			array.add(listAdapter.GetmData().get(i));		for (MessagePost p : stars) {			// map_use = new HashMap<String, Object>();			// url = p.getUrl();			// title = p.getName();			// if (title.length() > 12) {			// title = title.substring(0, 11);			// title += "...";			// }			// large_url = p.getLargeUrl();			// id = p.getId();			// description = p.getDescription();			// desc = description;			// if (description.length() > 30) {			// desc = description.substring(0, 29);			// desc += "...";			// }			// map_use.put("url", large_url);			// map_use.put("id", id);			// map_use.put("imgsrc", MyConstants.SITE + url);			// map_use.put("desc", desc);			// map_use.put("description", description);			// map_use.put("title", title);			map_use = getMap(p);			array.add(map_use);		}		last_star_id += stars.size();		if (stars.size() == 0) {			listHandler.obtainMessage(MyConstants.MSG_FAILURE).sendToTarget();		} else {			listHandler.obtainMessage(MyConstants.MSG_SUCCESS1, array)					.sendToTarget();		}	}		private class OnMsgClickListener implements OnClickListener {		public void onClick(View v) {			try {				loadMoreButton.setText("查看更多...");				bottomFlag = false;				progressDialogFirstTime.show();				buildlist();				 			} catch (JSONException e) {				e.printStackTrace();			} catch (IOException e) {				e.printStackTrace();			}		}	};}